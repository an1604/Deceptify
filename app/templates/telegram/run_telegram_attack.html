{% import "_macros.html" as macros %}
{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Deceptify- Run Attack{% endblock %}

{% block page_content %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
            integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
            integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ=="
            crossorigin="anonymous"></script>

    <style>
    .text-container {
        padding: 20px;
        border-radius: 8px;
        max-width: 800px; /* Limit the width for better readability */
        margin: 20px auto; /* Center the container */
        color: #ffffff; /* Text color */
        font-size: 18px; /* Increase font size */
        line-height: 1.6; /* Improve line spacing */
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); /* Subtle text shadow for better contrast */
    }
    form input[type="text"],
    form input[type="submit"] {
        width: 100%;
        padding: 10px 15px;
        margin: 10px 0;
        font-size: 16px; /* Increased font size */
        border: 2px solid #1abc9c; /* Adding a border */
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
        color: #2c3e50; /* Dark text color */
}

        form input[type="submit"] {
            background-color: #1abc9c; /* Green background for the submit button */
            color: white; /* White text */
            cursor: pointer;
            transition: background-color 0.3s ease; /* Smooth transition */
        }

        form input[type="submit"]:hover {
            background-color: #16a085; /* Darker green on hover */
        }

        /* Add a container with a background for better readability */
        #initClientContainer {
            padding: 20px;
            border-radius: 10px;
            max-width: 500px; /* Set a maximum width */
            margin: 30px auto; /* Center the form container */
        }

        #attackContainer {
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black background */
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            margin: 30px auto;
        }

        #container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        #log, #new_messages {
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white background for logs */
            padding: 10px;
            border-radius: 5px;
            color: #2c3e50; /* Dark text color */
        }

        #loading {
            color: #ff0000; /* Red color for loading text */
            font-weight: bold;
            display: none; /* Hide the loading text by default */
        }

        input::placeholder {
            color: #7f8c8d; /* Light gray placeholder text */
            font-style: italic; /* Italicize placeholder text */
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        button {
            background-color: #1abc9c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #16a085;
        }
    </style>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function () {
            var socket = io();

            socket.on('connect', function () {
                socket.emit('connect_event', {data: 'I\'m connected!'});
                $('#initClientContainer').show();
            });

            socket.on('connection_update', function (msg, cb) {
                const isConnected = msg.data;
                var initClientContainer = $('#initClientContainer');
                var attackContainer = $('#attackContainer');
                var loadingIndicator = $('#loading');

                if (isConnected === true) {
                    initClientContainer.hide();
                    attackContainer.show();
                } else {
                    alert("There was a problem with communicating with your profile, please try again.");
                    if (loadingIndicator) {
                        loadingIndicator.hide();
                    }
                }

                if (cb) {
                    cb();
                }
                return false;
            });

            socket.on('server_update', function (msg, cb) {
                $('#log').append('<br>' + $('<div/>').text('Server Update: ' + msg.data).html());
                if (cb)
                    cb();
            });

            // Handle client authentication request
            socket.on("client_auth", function (msg, cb) {
                var authCode = prompt("Authentication needed, please check out Telegram and provide the code that you've received:");

                if (authCode) {
                    socket.emit("auth_code", {code: authCode});
                }

                if (cb) {
                    cb();
                }
            });

            let displayedMessages = [];
            socket.on("new_messages_update", function (msg, cb) {
                $('#messages_received').val('');
                const messages = msg.data;
                for (const i in messages) {
                    if (!displayedMessages.includes(messages[i])) {
                        $('#messages_received').append('<br>' + $('<div/>').text('New Message: ' + messages[i]).html());
                        displayedMessages.push(messages[i]);  // Add to the list of displayed messages
                    }
                }
                if (cb) {
                    cb();
                }
            });

            socket.on("new_audio", function (msg, cb) {
                var audio = $('#myAudio')[0];
                var audioSource = $('#audioSource')[0];

                var file_url = "/get_audio?file_path=" + encodeURIComponent(msg.audio);

                audioSource.src = file_url;
                audio.load();

                $('#audioContainer').show();

                $('#acceptAndSendAudio').off('click').on('click', function (event) {
                    event.preventDefault();
                    socket.emit("client_audio_decision", {
                        action: 'accept',
                        audio: msg.audio,
                        receiver: $('#receiver_phone_number_audio').val()
                    });
                    $('#receiver_phone_number_audio').val('');
                    $('#audioContainer').hide();
                });

                $('#rejectAndRegenerate').off('click').on('click', function (event) {
                    event.preventDefault();
                    socket.emit("client_audio_decision", {
                        action: 'reject',
                        audio: msg.audio,
                        receiver: $('#receiver_phone_number_audio').val()
                    });
                    $('#receiver_phone_number_audio').val('');
                    $('#audioContainer').hide();
                });

                if (cb) {
                    cb();
                }
            });

            $('form#emit').submit(function (event) {
                event.preventDefault();
                socket.emit('new_message', {
                    message: $('#emit_data').val(),
                    receiver: $('#receiver_phone_number_text').val()
                });
                $('#emit_data').val('');
                $('#receiver_phone_number_text').val('');
            });

            $('form#audio').submit(function (event) {
                event.preventDefault();
                socket.emit('new_audio_generation', {
                    tts: $('#text_to_speech').val(),
                    profile_name_for_tts: $('#profile_name_for_tts').val()
                });
                $('#text_to_speech').val('');
            });

            $('form#ask_for_new_messages').submit(function (event) {
                event.preventDefault();
                socket.emit('ask_for_new_messages');
                return false;
            });

            $('form#initClientForm').submit(function (event) {
                event.preventDefault();
                var loadingIndicator = $('#loading');
                loadingIndicator.show();  // Show loading indicator during initialization

                socket.emit("init_client", {
                    app_id: $('#app_id').val(),
                    app_hash: $('#app_hash').val(),
                    phone_number: $('#phone_number').val(),
                    profile_name: $('#profile_name').val()
                });

                socket.on('connection_update', function (msg) {
                    loadingIndicator.hide();  // Hide loading indicator after connection update
                });
            });

            $('#initClientContainer').append('<div id="loading">Initializing...</div>');
        });
    </script>
    <div id="initClientContainer" style="display: none;">
        <form id="initClientForm" method="POST" action='#'>
            <input type="text" name="app_id" id="app_id" placeholder="Your App ID Here">
            <input type="text" name="app_hash" id="app_hash" placeholder="Your App Hash Here">
            <input type="text" name="profile_name" id="profile_name" placeholder="Your Profile Name Here">
            <input type="text" name="phone_number" id="phone_number" placeholder="Your Phone Number Here">
            <input type="submit" value="Authorize Client">
        </form>
        <div id="loading">Initializing...</div>
    </div>

    <div id="qrCode" style="display: none;">
        <img id="qrCodeImage" src="" alt="QR Code">
    </div>

    <div id="attackContainer" style="display: none;">
        <h2>Send:</h2>

        <form id="emit" method="POST" action='#'>
            <input type="text" name="emit_data" id="emit_data" placeholder="Message">
            <input type="text" name="receiver" id="receiver_phone_number_text" placeholder="Receiver Phone Number">
            <input type="submit" value="Send Text">
        </form>

        <form id="audio" method="POST" action='#'>
            <input type="text" name="emit_data" id="text_to_speech" placeholder="Text to Speech">
            <input type="text" name="profile_name_for_tts" id="profile_name_for_tts"
                   placeholder="Who's voice to clone?">
            <input type="text" name="receiver" id="receiver_phone_number_audio" placeholder="Receiver Phone Number">
            <input type="submit" value="Generate Audio">
        </form>

        <div id="audioContainer" style="display: none;">
            <audio id="myAudio" controls>
                <source id="audioSource" type="audio/mpeg" src="">
                Your browser does not support the audio element.
            </audio>
            <button type="button" id="acceptAndSendAudio">Accept and Send Audio</button>
            <button type="button" id="rejectAndRegenerate">Reject and Regenerate Audio</button>
        </div>

        <div id="container">
            <div id="log"></div>
            <div id="new_messages">
                <form id="ask_for_new_messages" method="POST" action="#">
                    <div id="messages_received"></div>
                    <input type="submit" value="Check If You Got New Messages">
                </form>
            </div>
        </div>
    </div>
{% endblock %}
